<section id="wallet-setup">
    <h2>Wallet setup</h2>
    <p>This section specifies how the user can set their [=wallet address=] for Web Monetization in the user agent.</p>

    <section>
    <h3>Terms</h3>
    <dl>
        <dt><dfn>Web Monetization page</dfn></dt>
        <dd>
            Refers to the browser's UI for managing Web Monetization settings, accessible via a browser specific URI.
            <span class="note">In Chromium based browser the page can be located at `chrome://webmonetization`.</span>
        </dd>
        <dt><dfn data-lt="setup page">Web Monetization setup page</dfn></dt>
        <dd>
            Refers to the browser's UI for setting up Web Monetization on the [=Web Monetization page=]. The UI lets user specify the [=wallet address=], and the budget.
            <span class="note">An example of such a UI could be an "Add a Wallet" button that opens a dialog for entering this information, with an "Add" button that starts the wallet connection process when clicked.</span>
        </dd>
        <dt><dfn>Interactive grant</dfn></dt>
        <dd>
            Open Payments requires outgoing payment [=grant=] requests to be interactive. When a grant request is interactive, it means explicit interaction by an individual (typically the clientâ€™s end user) is a required step in the delegation process.
        </dd>
        <dd>
            After the grant request is made, the client must poll for a Grant Continuation request so the [=AS=] knows to issue an access token.
        </dd>
        <dt><dfn>Redirect URI</dfn></dt>
        <dd>
            The redirect URI is an URL the user is redirected to in order to accept or decline the outgoing payment grant ([=interactive grant=]) when conneting their [=wallet=] to the browser.
        </dd>
    </dl>
    </section>

    <!-- Authentication keys details live under the Authentication section; this page references the keypair generation step below. -->

    <section class="algorithm">
    <h3>Connecting a wallet</h3>

    <p>The user can initiate the wallet setup from the [=setup page=]. The [=setup page=] provides
    UI that lets the user: (1) enter a [=wallet address=]; (2) specify an initial spending budget;
    (3) optionally enable automatic monthly renewal; and (4) after authentication {{ Storage/keys }} generation,
    view and copy the newly generated public key so it can be registered with the connected wallet
    for client identification.</p>

    <p>To <b><em>process the wallet setup</em></b>, given a string |walletAddress:DOMString| (the [=wallet address=] provided by the user),
      a number |budget:number| (the budget that the user wants to use for Web Monetization) and
      a boolean |renewMonthly: boolean| (an option to renew the budget every month):</p>
    <ol>
        <li>
            Let |walletAddressDetails:WalletAddressDetails| be the result of the [=send a wallet address request=] algorithm on |walletAddress|.
        </li>
        <li>Run the [=generate an Ed25519 key pair=] algorithm.</li>
        <li>
            Let |interval:DOMString| be an <a href="https://en.wikipedia.org/wiki/ISO_8601#Repeating_intervals">ISO 8601 repeating interval</a> if <var>renewMonthly</var> is `true`.
            <span class="note">
                The starting date for the repeating interval needs to be the users current date (ISO String).
            </span>
            <aside class="example" title="ISO 8601 Repeating interval - monthly renewal">
               <pre class="text">
                  R/2025-01-28T02:12:16.254Z/P1M
               </pre>
            </aside>
        </li>
        <li>
            Let |pendingGrant:PendingGrant| ({{PendingGrant}}) be the result of the [=send an outgoing payment and quote grant request=] algorithm with |walletAddressDetails|, |budget| and |interval|.
            <p class="note">
                Since we ask for access to outgoing payments, the user will have to interact with the grant (approve or decline). Currently in Open Payments, only the grants that request access to outgoing payments are interactive.
            </p>
        </li>
        <li>
            Let |continueUri:DOMString| be |pendingGrant|'s {{PendingGrant/continue}}.{{Continue/uri}} property at which the client instance can make <a data-cite="opas/operations/post-continue#">continuation requests</a>.
        </li>
        <li>
            Let |continueAccessToken:DOMString| be |pendingGrant|'s {{PendingGrant/continue}}.{{Continue/access_token}}.{{AccessToken/value}} property.
        </li>
        <li>
            (TODO: Look into browsing/navigation context, instead of specifying "open in a new tab") Open the |pendingGrant|'s {{PendingGrant/interact}}.{{PendingInteract/redirect}} property ([=Redirect URI=]) in a new tab to redirect the user to their wallet's [=IdP=], where the user can accept or decline the grant.
        </li>
        <li>
            Let |wait:number| be |pendingGrant|'s {{PendingGrant/continue}}.{{Continue/wait}} property.
            <div class="note">
                <p>We cannot use the {{PendingInteract/finish}} redirect method as browser's internal URLs can not be opened from an external source. In the Open Payments scenario, the [=AS=] will have to redirect the user to the internal browser page for Web Monetization to continue the flow.</p>
                <p>Since we cannot use Open Payments' redirect {{PendingInteract/finish}} method, we will have to check every <var>wait</var> seconds (<a href="https://en.wikipedia.org/wiki/Polling_(computer_science)">polling</a>) to retrieve information about the grant (whether user accepted or rejected the grant).</p>
            </div>
        </li>
        <li>Let <var>finalizedGrant</var> be `null`.</li>
        <li>
            <p>Start polling to get the information about the grant state every <var>wait</var> seconds.</p>
            <ol>
                <li>Let |interval:number| be result of |wait| multiplied by 1000, as <var>wait</var> is defined in seconds.</li>
                <li>
                    Let <var>intervalId</var> be the result of calling {{ WindowOrWorkerGlobalScope/setInterval() }} with |interval| and the following steps as callback:
                </li>
                <li>
                        Let |grant| be the result of running the [=send a continue grant request=] algorithm given <var>continueUri</var> and <var>continueAccessToken</var>
                        <ol>
                            <li>
                                If |grant| is failure (not an [=ok status=]), call {{ WindowOrWorkerGlobalScope/clearInterval(id)|clearInterval(intervalId) }}.
                            </li>
                            <li>
                                If |grant| is of type {{ PendingGrant }}, continue polling.
                            </li>
                            <li>
                                If |grant| is of type {{ Grant }}, {{ WindowOrWorkerGlobalScope/clearInterval(id)|clearInterval(intervalId) }} and set <var>finallizedGrant</var> to |grant|.
                            </li>
                        </ol>
                </li>
            </ol>
        </li>
        <li>
            If |finalizedGrant| is not null, run the [=store grant credentials=] algorithm with |finalizedGrant|.
        </li>
    </ol>
    </section>
</section>
